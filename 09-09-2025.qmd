---
title: "Strategic Resilience and Financial Performance Profile for `r params$company`"
subtitle: "An In-depth Analysis by the Supply Chain Finance Lectoraat, Hogeschool Windesheim"
author:
  - name: Ronald de Boer 
    affiliations:
      - name: Supply Chain Finance Lectoraat
      - name: Hogeschool Windesheim
        address: Campus 2, Zwolle
bibliography: references.bib
format: 
  pdf:
    documentclass: article
    classoption: ["oneside", "open=any", "fontsize=11pt"]
    link-citations: false
    number-sections: false
    toc: false
    lof: false
    lot: false
    titlepage: "bg-image"
    titlepage-bg-image: "img/corner-bg.png"
    titlepage-logo: "img/logo.png" 
    titlepage-header: "Resilience Scan | NEXT GEN Logistics Initiative"
    titlepage-footer: |
      Supply Chain Finance Lectoraat, Hogeschool Windesheim\
      https://resiliencescan.org/ | https://www.windesheim.com/research/professorships/supply-chain-finance
    coverpage-include-file:
      - tex/copyright.tex
    titlepage-include-file:
      - tex/dedication.tex
    titlepage-theme:
      vrule-color: "004D40" 
      vrule-width: "10pt"
    coverpage: otter 
    coverpage-bg-image: "img/otter-bar.jpeg"
    coverpage-title: "resiliencescan" 
    coverpage-author: ["Supply Chain Finance Lectoraat, Hogeschool Windesheim", "NEXT GEN Logistics"] 
    coverpage-theme:
      title-color: "white"
      title-fontfamily: "QTDublinIrish.otf" 
      title-fontsize: 70
      author-style: "plain"
      author-sep: "newline"
      author-fontstyle: ["textbf", "textsc"]
      author-fontsize: 24
      author-color: "4CAF50" 
      author-align: "right"
      author-bottom: "1.5in"
      footer-style: "none"
      header-style: "none"
      date-style: "none"
    keep-tex: true
    # Temporarily remove complex header-includes for stability
    # header-includes: |
    #   \usepackage{fancyhdr}
    #   ... (rest of fancyhdr setup) ...
execute:
  echo: false
  warning: false
  message: false
params:
  company: "Placeholder Company"
---



```{r package-installer, include=FALSE}
# Define required R packages
required_packages <- c(
  "readr", "dplyr", "stringr", "tidyr", "ggplot2", 
  "fmsb", "scales", "janitor",
  "rmarkdown", "knitr", "bookdown", "tinytex", "quarto"
)

# Detect and install missing R packages
missing_packages <- required_packages[!sapply(required_packages, requireNamespace, quietly = TRUE)]

if (length(missing_packages) > 0) {
  message("📦 Installing missing R packages: ", paste(missing_packages, collapse = ", "))
  install.packages(missing_packages, repos = "https://cran.rstudio.com/", dependencies = TRUE)
} else {
  message("✅ All required R packages are already installed.")
}

# Check TinyTeX
if (!tinytex::is_tinytex()) {
  message("📦 TinyTeX not detected — installing TinyTeX...")
  tinytex::install_tinytex()
} else {
  message("✅ TinyTeX already installed.")
}

# Check Quarto CLI
quarto_path <- Sys.which("quarto")

if (quarto_path == "") {
  warning("❌ Quarto CLI is not installed! Please install it from https://quarto.org/download/ before continuing.")
} else {
  message("✅ Quarto CLI detected at: ", quarto_path)
  

}
```
```{r helpers, include=FALSE}
# Helper functions
safe_print_score <- function(score) {
  if (is.na(score) || is.null(score) || !is.numeric(score)) {
    return("N/A")
  }
  return(sprintf("%.2f", score))
}

convert_to_numeric_simple <- function(x) {
  x_char <- as.character(x)
  x_char <- ifelse(tolower(trimws(x_char)) %in% c("?", "", " ", "n/a", "na", "n.a.", "nan"), NA_character_, x_char)
  suppressWarnings(as.numeric(str_replace(x_char, ",", ".")))
}
```

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(fmsb)
library(scales) 

df_full <- read_csv("data/cleaned_master.csv", col_types = cols(.default = "c"))
colnames(df_full) <- tolower(trimws(colnames(df_full)))

df_company_raw <- df_full %>% 
  filter(tolower(company_name) == tolower(params$company))

score_columns_to_convert <- c(
  "up__r", "up__c", "up__f", "up__v", "up__a",
  "in__r", "in__c", "in__f", "in__v", "in__a",
  "do__r", "do__c", "do__f", "do__v", "do__a",
  "overall_scres"
)

info_cols_to_keep <- c("company_name", "sector", "size_number_of_employees")

actual_score_columns_to_convert <- intersect(score_columns_to_convert, names(df_company_raw))
actual_info_cols_to_keep <- intersect(info_cols_to_keep, names(df_company_raw))

df_company_numeric <- df_company_raw

# Convert numeric columns using the function from helpers chunk
if (length(actual_score_columns_to_convert) > 0) {
    df_company_numeric <- df_company_numeric %>%
      mutate(across(all_of(actual_score_columns_to_convert), convert_to_numeric_simple))
}

up_cols <- c("up__r", "up__c", "up__f", "up__v", "up__a")
in_cols <- c("in__r", "in__c", "in__f", "in__v", "in__a")
do_cols <- c("do__r", "do__c", "do__f", "do__v", "do__a")
max_score <- 5 
min_score <- 0 
dimension_labels <- c("Redundancy", "Collaboration", "Flexibility", "Transparency", "Agility")

data_up_radar <- NULL
data_in_radar <- NULL
data_do_radar <- NULL
company_sector <- "Not Specified" 
company_size <- "Not Specified"   

if(nrow(df_company_numeric) >= 1) {
  if(nrow(df_company_numeric) > 1) {
    warning(paste("Multiple rows found for company:", params$company, ". Using the first row only."))
    df_company_numeric <- df_company_numeric[1, , drop = FALSE] 
  }
  
  company_sector <- if("sector" %in% names(df_company_numeric) && !is.na(df_company_numeric$sector) && df_company_numeric$sector != "") df_company_numeric$sector else "Not Specified"
  company_size <- if("size_number_of_employees" %in% names(df_company_numeric) && !is.na(df_company_numeric$size_number_of_employees) && df_company_numeric$size_number_of_employees != "") df_company_numeric$size_number_of_employees else "Not Specified"

  if(all(up_cols %in% names(df_company_numeric))) {
    df_company_numeric$up_pillar_score <- rowMeans(select(df_company_numeric, all_of(up_cols)), na.rm = TRUE)
    radar_data <- df_company_numeric %>% slice(1) %>% select(all_of(up_cols))
    if(ncol(radar_data) == 5 && !all(is.na(as.numeric(radar_data[1,])))) {
        data_up_radar <- data.frame(rbind(rep(max_score, 5), rep(min_score, 5), as.numeric(radar_data[1,])))
        colnames(data_up_radar) <- dimension_labels
    } else { warning(paste("Upstream radar data for", params$company, "could not be prepared."))}
  } else { df_company_numeric$up_pillar_score <- NA }

  if(all(in_cols %in% names(df_company_numeric))) {
    df_company_numeric$in_pillar_score <- rowMeans(select(df_company_numeric, all_of(in_cols)), na.rm = TRUE)
    radar_data <- df_company_numeric %>% slice(1) %>% select(all_of(in_cols))
    if(ncol(radar_data) == 5 && !all(is.na(as.numeric(radar_data[1,])))) {
        data_in_radar <- data.frame(rbind(rep(max_score, 5), rep(min_score, 5), as.numeric(radar_data[1,])))
        colnames(data_in_radar) <- dimension_labels
    } else { warning(paste("Internal radar data for", params$company, "could not be prepared."))}
  } else { df_company_numeric$in_pillar_score <- NA }

  if(all(do_cols %in% names(df_company_numeric))) {
    df_company_numeric$do_pillar_score <- rowMeans(select(df_company_numeric, all_of(do_cols)), na.rm = TRUE)
    radar_data <- df_company_numeric %>% slice(1) %>% select(all_of(do_cols))
    if(ncol(radar_data) == 5 && !all(is.na(as.numeric(radar_data[1,])))) {
        data_do_radar <- data.frame(rbind(rep(max_score, 5), rep(min_score, 5), as.numeric(radar_data[1,])))
        colnames(data_do_radar) <- dimension_labels
    } else { warning(paste("Downstream radar data for", params$company, "could not be prepared."))}
  } else { df_company_numeric$do_pillar_score <- NA }

} else if (nrow(df_company_numeric) == 0) {
  stop(paste("No data found for company:", params$company, ". Halting report generation."))
}

# Prepare overlay and overall data
has_up <- exists("data_up_radar") && is.data.frame(data_up_radar) && nrow(data_up_radar) == 3 && ncol(data_up_radar) == 5 && all(sapply(data_up_radar, is.numeric)) && !all(is.na(data_up_radar[3, , drop=FALSE]))
has_in <- exists("data_in_radar") && is.data.frame(data_in_radar) && nrow(data_in_radar) == 3 && ncol(data_in_radar) == 5 && all(sapply(data_in_radar, is.numeric)) && !all(is.na(data_in_radar[3, , drop=FALSE]))
has_do <- exists("data_do_radar") && is.data.frame(data_do_radar) && nrow(data_do_radar) == 3 && ncol(data_do_radar) == 5 && all(sapply(data_do_radar, is.numeric)) && !all(is.na(data_do_radar[3, , drop=FALSE]))

if (has_up || has_in || has_do) {
  available_rows <- list()
  if (has_up) available_rows <- append(available_rows, list(as.numeric(data_up_radar[3,])))
  if (has_in) available_rows <- append(available_rows, list(as.numeric(data_in_radar[3,])))
  if (has_do) available_rows <- append(available_rows, list(as.numeric(data_do_radar[3,])))

  overall_vec <- Reduce("+", available_rows) / length(available_rows)
  data_overall_radar <- data.frame(rbind(
    rep(max_score, 5),
    rep(min_score, 5),
    overall_vec
  ))
  colnames(data_overall_radar) <- dimension_labels
} else {
  data_overall_radar <- NULL
}

overlay_data <- NULL
if (has_up || has_in || has_do) {
  overlay_data <- rbind(rep(max_score, 5), rep(min_score, 5))
  if (has_up) overlay_data <- rbind(overlay_data, as.numeric(data_up_radar[3,]))
  if (has_in) overlay_data <- rbind(overlay_data, as.numeric(data_in_radar[3,]))
  if (has_do) overlay_data <- rbind(overlay_data, as.numeric(data_do_radar[3,]))
  overlay_data <- as.data.frame(overlay_data)
  colnames(overlay_data) <- dimension_labels
}
```

```{r dashboard-radars, fig.width=16, fig.height=24}
# Dashboard layout with company introduction and radar charts - optimized for A4
op <- par(no.readonly = TRUE)
on.exit(par(op), add = TRUE)

# Set up layout: 1 row for intro, then 3x2 grid for charts
layout_matrix <- matrix(c(
  1, 1,  # Company introduction spans 2 columns
  2, 3,  # Overall and Comparative 
  4, 5,  # Upstream and Internal
  6, 7   # Downstream and Summary
), nrow = 4, byrow = TRUE)

layout(layout_matrix, heights = c(0.2, 0.27, 0.27, 0.26))
par(oma = c(2, 2, 4, 2))

# Panel 1: Company Introduction
par(mar = c(2, 3, 3, 3))
plot.new()

# Background box for introduction
rect(0.02, 0.1, 0.98, 0.9, col = "#f8f9fa", border = "#dee2e6", lwd = 2)

# Company name as main header
text(0.5, 0.75, params$company, cex = 2.2, font = 2, col = "#2c3e50")

# Company details in a structured format
left_col_x <- 0.25
right_col_x <- 0.75
detail_y <- 0.55

# Left column - Company basics
text(left_col_x, detail_y, "COMPANY PROFILE", cex = 1.2, font = 2, col = "#495057", adj = c(0.5, 0.5))
text(left_col_x, detail_y - 0.08, paste("Sector:", company_sector), cex = 1.1, col = "#6c757d", adj = c(0.5, 0.5))
text(left_col_x, detail_y - 0.16, paste("Size:", company_size), cex = 1.1, col = "#6c757d", adj = c(0.5, 0.5))

# Right column - Assessment info
text(right_col_x, detail_y, "ASSESSMENT OVERVIEW", cex = 1.2, font = 2, col = "#495057", adj = c(0.5, 0.5))
text(right_col_x, detail_y - 0.08, "Supply Chain Resilience Analysis", cex = 1.1, col = "#6c757d", adj = c(0.5, 0.5))
text(right_col_x, detail_y - 0.16, "5 Dimensions × 3 Supply Chain Segments", cex = 1.1, col = "#6c757d", adj = c(0.5, 0.5))

# Bottom description
text(0.5, 0.25, "This dashboard presents a comprehensive analysis of supply chain resilience across five key dimensions:", 
     cex = 1.0, col = "#495057", adj = c(0.5, 0.5))
text(0.5, 0.18, "Redundancy • Collaboration • Flexibility • Transparency • Agility", 
     cex = 1.1, font = 2, col = "#6a1b9a", adj = c(0.5, 0.5))

# Panel 2: Overall (top-left)
if (!is.null(data_overall_radar)) {
  par(mar = c(3, 3, 4, 3))
  fmsb::radarchart(
    data_overall_radar, axistype = 1,
    pcol = "#6A1B9A", pfcol = scales::alpha("#6A1B9A", 0.4), plwd = 3, plty = 1,
    cglcol = "grey80", cglty = 1, axislabcol = "grey40",
    caxislabels = sprintf("%.1f", seq(min_score, max_score, length.out = 6)),
    cglwd = 1.2, vlcex = 1.1, centerzero = TRUE, title = "Overall Resilience"
  )
} else {
  plot.new()
  title("Overall Resilience\n(no data available)", cex.main = 1.2)
}

# Panel 3: Comparative Overlay (top-right)
if (!is.null(overlay_data)) {
  n_series <- nrow(overlay_data) - 2
  cols <- c("#0277BD", "#FF8F00", "#2E7D32")[seq_len(n_series)]
  fcols <- sapply(cols, function(z) scales::alpha(z, 0.25))
  par(mar = c(3, 3, 4, 3))
  fmsb::radarchart(
    overlay_data, axistype = 1,
    pcol = cols, pfcol = fcols, plwd = 3, plty = 1,
    cglcol = "grey80", cglty = 1, axislabcol = "grey40",
    caxislabels = sprintf("%.1f", seq(min_score, max_score, length.out = 6)),
    cglwd = 1.2, vlcex = 1.1, centerzero = TRUE, title = "Comparative Analysis"
  )
  legend("bottomright",
    legend = c(if (has_up) "Upstream" else NULL,
               if (has_in) "Internal" else NULL,
               if (has_do) "Downstream" else NULL),
    col = cols[1:n_series],
    lty = 1, lwd = 3, bty = "n", cex = 0.9, text.col = "grey20")
} else {
  plot.new()
  title("Comparative Analysis\n(no data available)", cex.main = 1.2)
}

# Panel 4: Upstream (middle-left)
if (has_up) {
  par(mar = c(3, 3, 4, 3))
  fmsb::radarchart(
    data_up_radar, axistype = 1,
    pcol = "#0277BD", pfcol = scales::alpha("#0277BD", 0.45), plwd = 3, plty = 1,
    cglcol = "grey80", cglty = 1, axislabcol = "grey40",
    caxislabels = sprintf("%.1f", seq(min_score, max_score, length.out = 6)),
    cglwd = 1.2, vlcex = 1.1, centerzero = TRUE, title = "Upstream Supply Chain"
  )
} else {
  plot.new()
  title("Upstream Supply Chain\n(no data available)", cex.main = 1.2)
}

# Panel 5: Internal (middle-right)
if (has_in) {
  par(mar = c(3, 3, 4, 3))
  fmsb::radarchart(
    data_in_radar, axistype = 1,
    pcol = "#FF8F00", pfcol = scales::alpha("#FF8F00", 0.45), plwd = 3, plty = 1,
    cglcol = "grey80", cglty = 1, axislabcol = "grey40",
    caxislabels = sprintf("%.1f", seq(min_score, max_score, length.out = 6)),
    cglwd = 1.2, vlcex = 1.1, centerzero = TRUE, title = "Internal Operations"
  )
} else {
  plot.new()
  title("Internal Operations\n(no data available)", cex.main = 1.2)
}

# Panel 6: Downstream (bottom-left)
if (has_do) {
  par(mar = c(3, 3, 4, 3))
  fmsb::radarchart(
    data_do_radar, axistype = 1,
    pcol = "#2E7D32", pfcol = scales::alpha("#2E7D32", 0.45), plwd = 3, plty = 1,
    cglcol = "grey80", cglty = 1, axislabcol = "grey40",
    caxislabels = sprintf("%.1f", seq(min_score, max_score, length.out = 6)),
    cglwd = 1.2, vlcex = 1.1, centerzero = TRUE, title = "Downstream Distribution"
  )
} else {
  plot.new()
  title("Downstream Distribution\n(no data available)", cex.main = 1.2)
}

# Panel 7: Summary Statistics (bottom-right) - Fixed sizing
par(mar = c(3, 3, 4, 3))
plot.new()
plot.window(xlim = c(0, 1), ylim = c(0, 1))

# Create a more compact summary with better positioning
rect(0.05, 0.05, 0.95, 0.95, col = "#f8f9fa", border = "grey70", lwd = 2)

# Header
text(0.5, 0.88, "PERFORMANCE SUMMARY", cex = 1.3, font = 2, col = "#2c3e50")

# Horizontal line
segments(0.15, 0.82, 0.85, 0.82, col = "grey60", lwd = 2)

# Pillar scores with color coding - more compact spacing
y_positions <- c(0.72, 0.62, 0.52, 0.42)
labels <- c("OVERALL", "Upstream", "Internal", "Downstream")
scores <- c(
  safe_print_score(df_company_numeric$overall_scres),
  safe_print_score(df_company_numeric$up_pillar_score),
  safe_print_score(df_company_numeric$in_pillar_score),
  safe_print_score(df_company_numeric$do_pillar_score)
)

for (i in 1:4) {
  # Score label
  text(0.22, y_positions[i], labels[i], cex = 1.0, font = ifelse(i==1, 2, 1), 
       adj = c(0, 0.5), col = "grey30")
  
  # Score value with background
  score_val <- scores[i]
  if (score_val != "N/A" && !is.na(as.numeric(score_val))) {
    score_num <- as.numeric(score_val)
    bg_color <- if (score_num >= 4) "#27ae60" else if (score_num >= 3) "#f39c12" else "#e74c3c"
    
    rect(0.65, y_positions[i] - 0.02, 0.85, y_positions[i] + 0.02, 
         col = bg_color, border = NA)
    text(0.75, y_positions[i], score_val, cex = 1.2, font = 2, col = "white")
  } else {
    text(0.75, y_positions[i], score_val, cex = 1.0, font = 1, col = "grey50")
  }
}

# Scale information - more compact
text(0.5, 0.32, "SCALE REFERENCE", cex = 1.0, font = 2, col = "grey30")
text(0.5, 0.26, "0.0-2.9: Needs Improvement", cex = 0.85, col = "#e74c3c")
text(0.5, 0.22, "3.0-3.9: Good Performance", cex = 0.85, col = "#f39c12")
text(0.5, 0.18, "4.0-5.0: Excellence", cex = 0.85, col = "#27ae60")

# Methodology note
text(0.5, 0.10, "Based on Supply Chain Finance Lectoraat", cex = 0.75, col = "grey50", font = 3)
text(0.5, 0.06, "Resilience Assessment Framework", cex = 0.75, col = "grey50", font = 3)

# Add main title
mtext("Supply Chain Resilience Dashboard", 
      outer = TRUE, cex = 1.8, font = 2, line = 1)

# Reset graphics parameters
par(op)
```