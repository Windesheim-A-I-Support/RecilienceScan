---
title: "Supply Chain Resilience Report"
format:
  pdf:
    documentclass: article
    geometry:
      - left=2cm
      - right=2cm
      - top=2cm
      - bottom=2cm
    papersize: a4
    keep-tex: false
params:
  company: "Example Company"
  person: "John Doe"
  diagnostic_mode: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Load required packages
library(dplyr)
library(fmsb)

# Get parameters
company_name <- params$company
person_name <- if (exists("params") && !is.null(params$person)) params$person else ""

# LaTeX escaping function
escape_latex <- function(text) {
  if (is.na(text) || is.null(text) || text == "") return(text)
  text <- gsub("\\\\", "\\\\textbackslash{}", text)
  text <- gsub("&", "\\\\&", text)
  text <- gsub("%", "\\\\%", text)
  text <- gsub("\\$", "\\\\$", text)
  text <- gsub("#", "\\\\#", text)
  text <- gsub("_", "\\\\_", text)
  text <- gsub("\\{", "\\\\{", text)
  text <- gsub("\\}", "\\\\}", text)
  text <- gsub("~", "\\\\textasciitilde{}", text)
  text <- gsub("\\^", "\\\\textasciicircum{}", text)
  return(text)
}

company_name_safe <- escape_latex(company_name)
person_name_safe <- escape_latex(person_name)

# Load data
csv_path <- "data/cleaned_master.csv"
all_data <- read.csv(csv_path, stringsAsFactors = FALSE, fileEncoding = "UTF-8")

# Filter for this company
company_data <- all_data %>% filter(company_name == !!company_name)

# If person specified, get individual data
if (nchar(person_name) > 0) {
  person_data <- company_data %>% filter(name == !!person_name)
  if (nrow(person_data) > 0) {
    individual_data <- person_data[1, ]
  } else {
    individual_data <- NULL
  }
} else {
  individual_data <- NULL
}

# Calculate scores
calc_score <- function(data, prefix) {
  cols <- paste0(prefix, "__", c("r", "c", "f", "v", "a"))
  values <- as.numeric(data[cols])
  if (all(is.na(values))) return(NA)
  mean(values, na.rm = TRUE)
}

if (!is.null(individual_data)) {
  up_score <- calc_score(individual_data, "up")
  in_score <- calc_score(individual_data, "in")
  do_score <- calc_score(individual_data, "do")
  overall_score <- mean(c(up_score, in_score, do_score), na.rm = TRUE)
} else {
  up_score <- mean(company_data$up_SCRES, na.rm = TRUE)
  in_score <- mean(company_data$in_SCRES, na.rm = TRUE)
  do_score <- mean(company_data$do_SCRES, na.rm = TRUE)
  overall_score <- mean(company_data$overall_SCRES, na.rm = TRUE)
}

# Function to get radar data
get_radar_data <- function(data, prefix) {
  cols <- paste0(prefix, "__", c("r", "c", "f", "v", "a"))
  scores <- as.numeric(data[cols])
  # Return in order: R, C, F, V, A (fmsb plots first column at top, then clockwise)
  df <- data.frame(
    Robustness = scores[1],
    Cohesion = scores[2],
    Flexibility = scores[3],
    Velocity = scores[4],
    Awareness = scores[5]
  )
  # Add max/min rows for fmsb
  df <- rbind(c(5, 5, 5, 5, 5), c(1, 1, 1, 1, 1), df)
  return(df)
}
```

\newpage

# Supply Chain Resilience Analysis {.unnumbered}

::: {.content-visible when-format="pdf"}
% Header with logos
\begin{center}
\includegraphics[width=0.30\textwidth]{img/logo-resiliencescan.png}
\end{center}

\vspace{0.3cm}

\begin{minipage}[t]{0.65\textwidth}
\textbf{\Large `r company_name_safe`}

\vspace{0.2cm}

`r if (nchar(person_name) > 0) paste("\\textbf{Report for:}", person_name_safe, "\\\\")`

`r if (!is.null(individual_data) && "date" %in% names(individual_data) && !is.na(individual_data$date) && nchar(individual_data$date) > 0) paste("\\textbf{Survey Date:}", individual_data$date, "\\\\")`

\textbf{Overall SCRES:} `r sprintf("%.2f", overall_score)`/5.00

\vspace{0.1cm}

{\small\textit{NextGenResilience • RUG • Windesheim • Involvation}}
\end{minipage}\hfill
\begin{minipage}[t]{0.30\textwidth}
\raggedleft
\includegraphics[width=0.9\textwidth]{img/logo-windesheim.png}\\[2mm]
\includegraphics[width=0.9\textwidth]{img/logo-involvation.png}\\[2mm]
\includegraphics[width=0.9\textwidth]{img/logo-RUG.png}
\end{minipage}

\vspace{0.5cm}
:::

## Resilience Dashboard

```{r dashboard, fig.width=10, fig.height=10}
if (!is.null(individual_data)) {
  # Individual dashboard - 3 radar charts (UP, IN, DO)
  par(mfrow = c(2, 2), mar = c(2, 1, 3, 1))

  # UP pillar
  up_data <- get_radar_data(individual_data, "up")
  radarchart(up_data,
             title = "UP - Understanding & Planning",
             pcol = "#004D40", pfcol = scales::alpha("#004D40", 0.3),
             plwd = 2, cglcol = "grey", cglty = 1,
             axislabcol = "grey30", vlcex = 0.8,
             caxislabels = seq(1, 5, 1))

  # IN pillar
  in_data <- get_radar_data(individual_data, "in")
  radarchart(in_data,
             title = "IN - Integration & Innovation",
             pcol = "#00796B", pfcol = scales::alpha("#00796B", 0.3),
             plwd = 2, cglcol = "grey", cglty = 1,
             axislabcol = "grey30", vlcex = 0.8,
             caxislabels = seq(1, 5, 1))

  # DO pillar
  do_data <- get_radar_data(individual_data, "do")
  radarchart(do_data,
             title = "DO - Deliver & Operate",
             pcol = "#26A69A", pfcol = scales::alpha("#26A69A", 0.3),
             plwd = 2, cglcol = "grey", cglty = 1,
             axislabcol = "grey30", vlcex = 0.8,
             caxislabels = seq(1, 5, 1))

  # Summary scores
  plot.new()
  par(mar = c(0, 0, 0, 0))
  text(0.5, 0.8, "Pillar Scores", cex = 1.5, font = 2)
  text(0.5, 0.6, sprintf("UP: %.2f", up_score), cex = 1.2)
  text(0.5, 0.5, sprintf("IN: %.2f", in_score), cex = 1.2)
  text(0.5, 0.4, sprintf("DO: %.2f", do_score), cex = 1.2)
  text(0.5, 0.2, sprintf("Overall: %.2f", overall_score), cex = 1.4, font = 2, col = "#004D40")

} else {
  # Company average dashboard
  text(0.5, 0.5, "Company average dashboard not yet implemented", cex = 1.5)
}
```

\newpage

## Dimension Details

The Supply Chain Resilience (SCRES) framework evaluates organizations across three pillars and five dimensions:

### Three Pillars

- **UP - Understanding & Planning**: Strategic foresight and preparation
- **IN - Integration & Innovation**: Collaboration and adaptation
- **DO - Deliver & Operate**: Execution and operations

### Five Dimensions (R-C-F-V-A)

- **Robustness (R)**: Ability to withstand disruptions
- **Cohesion (C)**: Internal and external collaboration
- **Flexibility (F)**: Adaptability to changes
- **Velocity (V)**: Speed of response
- **Awareness (A)**: Situational understanding

### Your Scores

```{r scores-table}
if (!is.null(individual_data)) {
  # Create scores table
  scores_df <- data.frame(
    Pillar = c("Understanding & Planning", "Integration & Innovation", "Deliver & Operate", "Overall SCRES"),
    Score = c(
      sprintf("%.2f", up_score),
      sprintf("%.2f", in_score),
      sprintf("%.2f", do_score),
      sprintf("%.2f", overall_score)
    )
  )

  knitr::kable(scores_df, align = c("l", "r"))
}
```

### What This Means

- **Score 4.0-5.0**: Excellent resilience capabilities
- **Score 3.0-3.9**: Good resilience with room for improvement
- **Score 2.0-2.9**: Moderate resilience, development needed
- **Score 1.0-1.9**: Low resilience, significant improvement required

### Next Steps

Contact us to discuss how to improve your supply chain resilience:

- Website: https://resiliencescan.org
- Email: info@resiliencescan.org

---

*This report is generated by the NEXT GEN Logistics Resilience initiative, a collaboration between Hogeschool Windesheim, University of Groningen, and Involvation.*
