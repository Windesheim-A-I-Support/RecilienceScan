---
title: "`r params$company`"
format:
  pdf:
    documentclass: article
    geometry: margin=1in
execute:
  echo: false
  warning: false
  message: false
params:
  company: "Placeholder Company"
---

```{r setup, include=FALSE}
library(readr)
library(dplyr)
library(stringr)
library(fmsb)
library(scales)

# Load the dataset
df_full <- read_csv("data/cleaned_master.csv", show_col_types = FALSE)
colnames(df_full) <- tolower(trimws(colnames(df_full)))

# Filter for selected company
df_company <- df_full %>%
  filter(tolower(company_name) == tolower(params$company))

if (nrow(df_company) == 0) {
  stop(paste("No data found for", params$company))
}

# Function to safely convert to numeric
convert_to_numeric <- function(x) {
  x <- ifelse(tolower(trimws(as.character(x))) %in% c("?", "", " ", "n/a", "na", "n.a.", "nan"), NA, x)
  suppressWarnings(as.numeric(str_replace(as.character(x), ",", ".")))
}

# Define column groups
up_cols <- c("up__r", "up__c", "up__f", "up__v", "up__a")
in_cols <- c("in__r", "in__c", "in__f", "in__v", "in__a")
do_cols <- c("do__r", "do__c", "do__f", "do__v", "do__a")
dims <- c("Resilience", "Connectivity", "Financial", "Visibility", "Agility")

max_score <- 5
min_score <- 0

# Function to prepare radar data
make_radar_data <- function(cols) {
  if (!all(cols %in% names(df_company))) return(NULL)
  vals <- df_company %>% select(all_of(cols)) %>% mutate(across(everything(), convert_to_numeric))
  if (any(is.na(vals[1,]))) return(NULL)
  data.frame(rbind(rep(max_score, length(cols)),
                   rep(min_score, length(cols)),
                   as.numeric(vals[1,]))) %>%
    setNames(dims)
}

# Create datasets for each radar
data_up <- make_radar_data(up_cols)
data_in <- make_radar_data(in_cols)
data_do <- make_radar_data(do_cols)
```

# `r params$company`

```{r radar-plots, fig.width=9, fig.height=4}
par(mfrow=c(1,3), mar=c(1,1,2,1))

if (!is.null(data_up)) {
  radarchart(data_up, axistype=1,
             pcol="#0277BD", pfcol=alpha("#0277BD", 0.5), plwd=2,
             cglcol="grey", cglty=1, axislabcol="grey40",
             caxislabels=seq(min_score, max_score, 1), cglwd=0.8,
             vlcex=0.8, title="Upstream")
} else { plot.new(); title("Upstream"); text(0.5,0.5,"No Data") }

if (!is.null(data_in)) {
  radarchart(data_in, axistype=1,
             pcol="#FF8F00", pfcol=alpha("#FF8F00", 0.5), plwd=2,
             cglcol="grey", cglty=1, axislabcol="grey40",
             caxislabels=seq(min_score, max_score, 1), cglwd=0.8,
             vlcex=0.8, title="Internal")
} else { plot.new(); title("Internal"); text(0.5,0.5,"No Data") }

if (!is.null(data_do)) {
  radarchart(data_do, axistype=1,
             pcol="#2E7D32", pfcol=alpha("#2E7D32", 0.5), plwd=2,
             cglcol="grey", cglty=1, axislabcol="grey40",
             caxislabels=seq(min_score, max_score, 1), cglwd=0.8,
             vlcex=0.8, title="Downstream")
} else { plot.new(); title("Downstream"); text(0.5,0.5,"No Data") }
```
