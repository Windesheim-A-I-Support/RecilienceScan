{% extends "base.html" %}

{% block title %}Runs - ResilienceScan Control Panel{% endblock %}

{% block content %}
<section id="runs-list">
    <h1>Recent Runs</h1>

    <div class="run-filters">
        <label for="run-type-filter">Filter by type:</label>
        <select id="run-type-filter" onchange="filterRuns()">
            <option value="">All Types</option>
            <option value="ingest">Ingest</option>
            <option value="render">Render</option>
        </select>

        <label for="status-filter">Filter by status:</label>
        <select id="status-filter" onchange="filterRuns()">
            <option value="">All Statuses</option>
            <option value="completed">Completed</option>
            <option value="running">Running</option>
            <option value="failed">Failed</option>
            <option value="pending">Pending</option>
        </select>
    </div>

    <table class="runs-table">
        <thead>
            <tr>
                <th>Run ID</th>
                <th>Type</th>
                <th>Status</th>
                <th>Company/Task</th>
                <th>Duration</th>
                <th>Created</th>
                <th>Updated</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if runs %}
                {% for run in runs %}
                <tr class="run-row" data-type="{{ run.type }}" data-status="{{ run.status }}">
                    <td class="run-id">{{ run.run_id[:8] }}...</td>
                    <td class="run-type">{{ run.type }}</td>
                    <td class="run-status status-{{ run.status }}">{{ run.status }}</td>
                    <td class="run-details">
                        {% if run.type == 'ingest' %}
                            Data Ingestion
                        {% elif run.type == 'render' %}
                            {{ run.company_name or 'Report Generation' }}
                        {% endif %}
                    </td>
                    <td class="run-duration">
                        {% if run.duration %}
                            {{ run.duration // 60 }}m {{ run.duration % 60 }}s
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="run-created">{{ run.created_at }}</td>
                    <td class="run-updated">{{ run.updated_at }}</td>
                    <td class="run-actions">
                        {% if run.status == 'failed' %}
                            <a href="/logs/{{ run.run_id }}" class="view-logs">View Logs</a>
                        {% elif run.status == 'completed' %}
                            {% if run.type == 'render' %}
                                <a href="/reports/{{ run.run_id }}" class="view-report">View Report</a>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr><td colspan="8" class="no-runs">No runs found</td></tr>
            {% endif %}
        </tbody>
    </table>

    <div class="pagination">
        <p class="result-count">Showing {{ runs|length }} of {{ count }} runs</p>
        {% if count > 50 %}
            <button onclick="loadMoreRuns()" id="load-more-btn">Load More</button>
        {% endif %}
    </div>
</section>

<style>
/* Runs List Styles */
#runs-list {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.run-filters {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    align-items: center;
}

.run-filters label {
    font-weight: 600;
    margin-right: 0.5rem;
}

.run-filters select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    background: white;
}

.runs-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 2rem;
}

.runs-table th {
    background: #f5f5f5;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #ddd;
}

.runs-table td {
    padding: 1rem;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
}

.run-id {
    font-family: monospace;
    color: #666;
}

.run-type {
    font-weight: 600;
    color: #333;
}

.run-status {
    font-weight: 600;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.9rem;
}

.status-completed {
    background: #d4edda;
    color: #155724;
}

.status-running {
    background: #d1ecf1;
    color: #0c5460;
}

.status-failed {
    background: #f8d7da;
    color: #721c24;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.run-details {
    color: #555;
    font-size: 0.95rem;
}

.run-duration {
    font-family: monospace;
    color: #888;
}

.run-actions {
    white-space: nowrap;
}

.view-logs,
.view-report {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 0.9rem;
    transition: background 0.3s ease;
}

.view-logs:hover,
.view-report:hover {
    background: #0056b3;
}

.no-runs {
    text-align: center;
    padding: 2rem;
    color: #999;
    font-style: italic;
}

.pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid #eee;
}

.result-count {
    color: #666;
    font-size: 0.9rem;
}

#load-more-btn {
    padding: 0.75rem 1.5rem;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
}

#load-more-btn:hover {
    background: #218838;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .run-filters {
        flex-direction: column;
        align-items: stretch;
    }

    .runs-table {
        font-size: 0.9rem;
    }

    .runs-table th,
    .runs-table td {
        padding: 0.75rem 0.5rem;
    }

    .pagination {
        flex-direction: column;
        align-items: center;
    }

    .result-count {
        margin-bottom: 1rem;
    }
}
</style>

<script>
// Filter runs based on type and status
function filterRuns() {
    const typeFilter = document.getElementById('run-type-filter').value;
    const statusFilter = document.getElementById('status-filter').value;

    const rows = document.querySelectorAll('.run-row');

    rows.forEach(row => {
        const rowType = row.dataset.type;
        const rowStatus = row.dataset.status;

        const typeMatch = !typeFilter || rowType === typeFilter;
        const statusMatch = !statusFilter || rowStatus === statusFilter;

        row.style.display = (typeMatch && statusMatch) ? '' : 'none';
    });
}

// Load more runs functionality
let currentOffset = 50;

async function loadMoreRuns() {
    try {
        const response = await fetch(`/runs?limit=50&offset=${currentOffset}`);
        const data = await response.json();

        if (data.runs.length === 0) {
            document.getElementById('load-more-btn').style.display = 'none';
            return;
        }

        const tbody = document.querySelector('.runs-table tbody');
        data.runs.forEach(run => {
            const row = createRunRow(run);
            tbody.appendChild(row);
        });

        currentOffset += 50;

        // Update result count
        const resultCount = document.querySelector('.result-count');
        resultCount.textContent = `Showing ${currentOffset} of ${data.count} runs`;

    } catch (error) {
        console.error('Error loading more runs:', error);
        alert('Failed to load more runs');
    }
}

// Create a table row for a run
function createRunRow(run) {
    const row = document.createElement('tr');
    row.className = 'run-row';
    row.dataset.type = run.type;
    row.dataset.status = run.status;

    row.innerHTML = `
        <td class="run-id">{{ run.run_id[:8] }}...</td>
        <td class="run-type">{{ run.type }}</td>
        <td class="run-status status-{{ run.status }}">{{ run.status }}</td>
        <td class="run-details">
            {% if run.type == 'ingest' %}
                Data Ingestion
            {% elif run.type == 'render' %}
                {{ run.company_name or 'Report Generation' }}
            {% endif %}
        </td>
        <td class="run-duration">
            {% if run.duration %}
                {{ run.duration // 60 }}m {{ run.duration % 60 }}s
            {% else %}
                -
            {% endif %}
        </td>
        <td class="run-created">{{ run.created_at }}</td>
        <td class="run-updated">{{ run.updated_at }}</td>
        <td class="run-actions">
            {% if run.status == 'failed' %}
                <a href="/logs/{{ run.run_id }}" class="view-logs">View Logs</a>
            {% elif run.status == 'completed' %}
                {% if run.type == 'render' %}
                    <a href="/reports/{{ run.run_id }}" class="view-report">View Report</a>
                {% endif %}
            {% endif %}
        </td>
    `;

    return row;
}

// Initialize on page load
window.addEventListener('load', () => {
    // Set up filtering
    filterRuns();
});
</script>
{% endblock %}